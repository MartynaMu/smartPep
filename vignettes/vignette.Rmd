---
title: "smartPep R package vignette"
author: "Martyna Muszczek"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    df_print: 
      kable
vignette: >
  %\VignetteIndexEntry{smartPep R package vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, 
  comment = "#>"
)
```

## Introduction

This package is used to process peptide quantification data obtained from DIA-NN (<https://github.com/vdemichev/DiaNN>) 'report.tsv' file and peptide binding affinity to MHC class I molecule prediction from NetMHCpan 4.1 .xls file with BA ranks.

## Dependencies

R packages:

-   tidyverse

-   diann

-   ComplexHeatmap

-   scrime

-   DEP

## Usage

The starting file is 'report.tsv' generated by DIA-NN software.

### `maxlfq()` - for peptide without modifications

This function applies `diann::maxlfq()` for peptide without modifications MaxLFQ algorithm and maintains important columns from the original report, such as "Protein.Ids", "Genes", "Stripped.Sequence" and "Modified.Sequence". Algorithm's cut-offs are Q.Value \<= 0.01 & PG.Q.Value \<= 0.01.

```{r message=FALSE, warning=FALSE}
library(smartPep)
df_quantified <- maxlfq("../example_data/report.tsv")
```

### `merge2reps()` - merge together technical duplicates

Make sure columns are arranged so the technical duplicates of the same sample are grouped together, one after another. Merging is done by averaging two measurements, or imputing one from another in case of NA's. Samples are grouped as they were in sequence and tagged as Sample1, Sample2 etc.

```{r}
df_merged <- merge2reps(df_quantified)
head(df_merged)
```

### Pivot to long format with NA rows exclusion after log2 transformation

```{r}
df_merged <- mutate(df_merged, log2(df_merged[5:8]))

long_df <- pivot_longer(df_merged, 
                        cols = 5:8, 
                        names_to = "Sample", 
                        values_to = "Intensity", 
                        values_drop_na = TRUE)
head(long_df)
```

### `sum_stats()` - compute basic statistics for each sample

```{r}
sum_stats(long_df)
```

### `plot_length_distr()` - analyze peptide length distribution per sample

```{r message=FALSE, warning=FALSE, fig.align='center'}
plot_length_distr(long_df)
```

### `pull_ids()` - retrieve peptide sequences or their genes of origin

```{r}
peptide_ids <- pull_ids(long_df, sample_col = "Sample", sequence_col = "Stripped.Sequence", save = FALSE)
head(peptide_ids$Sample3)
```

### `hm_all()` - plot a standardized global heatmap of peptide intensity

```{r message=FALSE, fig.align='center'}
hm_all(df_merged, 5:8)
```

### `hm_small()` - plot a standardized heatmap of peptide intensity based on a gene pattern of interest

Peptide indexes are generated next to a gene symbol.

```{r message=FALSE, fig.align='center'}
hm_small(df_merged, genePattern = "LGALS", cols = 5:8)
```

### `cleanup_ranks()` - extract BA ranks values for each HLA allele from an .xlsx file NetMHCpan 4.1 binding affinity results

Start by downloading .xls file from NetMHCpan 4.1 results with BA predictions. Open in Excel and save as .xlsx or other format. Then import it to your environment with the column names disabled. This is important, as there are two rows of column names and the `cleanup_ranks()` function extracts the important info from both rows.

```{r message=FALSE}
ba <- readxl::read_excel("../example_data/49497_NetMHCpan.xlsx", col_names = FALSE)

ba <- cleanup_ranks(ba)
head(ba)
```

### `binding_category()` - categorize NetMHCpan 4.1 BA_rank for each HLA allele

Categorize extracted BA_ranks to "Strong binder" (BA rank \< 0.5), "Weak binder" (BA rank \< 2) and "Non-binder" or "Binder" in case of assessing any allele.

```{r}
ba <- binding_category(ba)
head(ba)
```

### `plot_binder_shares()` - plot shares of binders for each HLA allele and globally
```{r, fig.align='center', fig.width=12, out.width="100%"}
ba_long <- pivot_longer(ba, 2:7,
                        values_to = "Binding category", 
                        names_to = "HLA supertype")

plot_binder_shares(ba_long, 
                   MHC_col = "HLA supertype", 
                   category_col = "Binding category")
```

